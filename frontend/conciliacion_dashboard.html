<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conciliaci√≥n Bancaria - Dashboard Mejorado</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .controls h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.3em;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }

        .form-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            align-items: end;
            margin-bottom: 20px;
        }

        .form-group-advanced {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .form-item {
            display: flex;
            flex-direction: column;
        }

        .form-item label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-item input, .form-item select {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-item input:focus, .form-item select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3498db;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f8b);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #229954, #1e8449);
            transform: translateY(-2px);
        }

        .results {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .results-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .summary-card.warning {
            border-left: 4px solid #ff9800;
            background: linear-gradient(135deg, #fff3e0 0%, #ffffff 100%);
        }

        .summary-number {
            font-size: 2em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .summary-label {
            color: #7f8c8d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .movements-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .movements-table th {
            background: #2c3e50;
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .movements-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }

        .movements-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .status-exact {
            background: #d5f4e6;
            color: #27ae60;
            border: 1px solid #a9dfbf;
        }

        .status-fuzzy {
            background: #fef5e7;
            color: #f39c12;
            border: 1px solid #fad7a0;
        }

        .status-pending {
            background: #fadbd8;
            color: #e74c3c;
            border: 1px solid #f1948a;
        }
        
        .status-duplicados {
            background: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }

        .error {
            background: #fadbd8;
            color: #c0392b;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #f1948a;
            border-left: 4px solid #e74c3c;
        }

        .success {
            background: #d5f4e6;
            color: #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #a9dfbf;
            border-left: 4px solid #27ae60;
        }

        .monto-comparison {
            font-family: 'Courier New', monospace;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .monto-banco {
            color: #2c3e50;
            font-weight: 600;
        }

        .monto-cfdi {
            color: #27ae60;
            font-weight: 600;
        }

        .monto-diferencia {
            color: #e74c3c;
            font-size: 0.85em;
            font-weight: 500;
        }

        .monto-label {
            font-size: 0.75em;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 70px;
            display: inline-block;
        }

        .monto-solo {
            color: #2c3e50;
            font-weight: 600;
        }

        .monto-info {
            font-size: 0.7em;
            color: #95a5a6;
            font-style: italic;
            margin-top: 3px;
        }

        .monto-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .monto-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .receptor-info {
            background: #e8f5e8;
            color: #27ae60;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-top: 5px;
            border: 1px solid #a9dfbf;
        }

        .config-info {
            background: #e3f2fd;
            color: #1976d2;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .config-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-value {
            font-weight: 600;
            color: #1565c0;
        }

        @media (max-width: 768px) {
            .form-group, .form-group-advanced {
                grid-template-columns: 1fr;
            }
            
            .results-summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ Conciliaci√≥n Bancaria</h1>
            <p>Sistema inteligente de conciliaci√≥n con prioridad PUE y P, monto y fecha</p>
        </div>

        <div class="controls">
            <h3>‚öôÔ∏è Configuraci√≥n de Conciliaci√≥n (PUE y P)</h3>
            
            <div class="form-group">
                <div class="form-item">
                    <label for="empresaId">Empresa ID</label>
                    <input type="number" id="empresaId" value="2" min="1">
                </div>
                <div class="form-item">
                    <label for="fechaInicio">Fecha Inicio</label>
                    <input type="date" id="fechaInicio">
                </div>
                <div class="form-item">
                    <label for="fechaFin">Fecha Fin</label>
                    <input type="date" id="fechaFin">
                </div>
                
            </div>

            <div class="form-group-advanced">
                <div class="form-item">
                    <div class="checkbox-group">
                        <input type="checkbox" id="soloPue" checked>
                        <label for="soloPue">Solo PUE (Pago en Una Exhibici√≥n) - P siempre incluido</label>
                    </div>
                </div>
                <div class="form-item">
                    <button class="btn btn-primary" onclick="ejecutarConciliacion()">üöÄ Ejecutar Conciliaci√≥n</button>
                </div>
                <div class="form-item">
                    <button class="btn btn-secondary" onclick="obtenerReporte()">üìä Ver Detalles</button>
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Procesando conciliaci√≥n...</p>
            </div>

            <div id="error" class="error" style="display: none;"></div>
            <div id="success" class="success" style="display: none;"></div>

           

            <div id="resultsSummary" class="results-header" style="display: none;">
                <div class="results-summary" id="summaryGrid"></div>
            </div>

            <div class="results-header" id="amountsHeader" style="display:none;">
                <h3>Resumen por montos</h3>
                <table class="movements-table" id="amountsTable">
                    <thead>
                        <tr>
                            <th>Monto</th>
                            <th>CFDI</th>
                            <th>Movimientos</th>
                            <th>Visita</th>
                        </tr>
                    </thead>
                    <tbody id="amountsBody"></tbody>
                </table>
            </div>

            <table class="movements-table" id="movementsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID Movimiento</th>
                        <th>Fecha</th>
                        <th>Concepto</th>
                        <th>Monto (Banco vs CFDI)</th>
                        <th>CFDI ID</th>
                        <th>Estado</th>
                        <th>Raz√≥n</th>
                        <th>Receptor</th>
                    </tr>
                </thead>
                <tbody id="movementsBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let currentData = null;

        async function ejecutarConciliacion() {
            console.log('üöÄ Iniciando ejecutarConciliacion...');
            
            // Verificar que todos los elementos existan
            const empresaIdEl = document.getElementById('empresaId');
            const fechaInicioEl = document.getElementById('fechaInicio');
            const fechaFinEl = document.getElementById('fechaFin');
            const soloPueEl = document.getElementById('soloPue');
            
            if (!empresaIdEl || !fechaInicioEl || !fechaFinEl || !soloPueEl) {
                console.error('‚ùå No se encontraron todos los elementos del formulario');
                showError('‚ùå Error: No se encontraron todos los elementos del formulario');
                return;
            }
            
            const empresaId = empresaIdEl.value;
            const fechaInicio = fechaInicioEl.value;
            const fechaFin = fechaFinEl.value;
            const soloPue = soloPueEl.checked;
            const incluirPpd = false; // PPD siempre excluido
            
            console.log('üìù Datos del formulario:', {
                empresaId, fechaInicio, fechaFin, soloPue, incluirPpd
            });
            
            showLoading();
            hideMessages();
            hideResults();
            
            try {
                let url = `http://localhost:8000/api/v1/conciliacion/ejecutar/${empresaId}`;
                const params = new URLSearchParams();
                
                if (fechaInicio) params.append('fecha_inicio', fechaInicio);
                if (fechaFin) params.append('fecha_fin', fechaFin);
                params.append('solo_pue', soloPue);
                params.append('incluir_ppd', incluirPpd);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                console.log('üåê URL de la petici√≥n:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Respuesta recibida:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Error de servidor:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('üìä Datos recibidos:', data);
                
                currentData = data;
                showResults(data);
                showSuccess('‚úÖ Conciliaci√≥n ejecutada exitosamente');
                
            } catch (error) {
                console.error('üí• Error completo:', error);
                showError(`‚ùå Error ejecutando conciliaci√≥n: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function obtenerReporte() {
            const empresaId = document.getElementById('empresaId').value;
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            showLoading();
            hideMessages();
            hideResults();
            
            try {
                let url = `http://localhost:8000/api/v1/conciliacion/detalles/${empresaId}`;
                const params = new URLSearchParams();
                
                if (fechaInicio) params.append('fecha_inicio', fechaInicio);
                if (fechaFin) params.append('fecha_fin', fechaFin);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                showReporte(data);
                showSuccess('üìä Detalles obtenidos exitosamente');
                
            } catch (error) {
                console.error('Error:', error);
                showError(`‚ùå Error obteniendo detalles: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function showResults(data) {
            console.log('üìã showResults llamada con data completa:', data);
            console.log('üìä data.resumen:', data.resumen);
            console.log('üìù data.detalles:', data.detalles);
            console.log('üìù data.detalles length:', data.detalles ? data.detalles.length : 'undefined');
            
            if (data.detalles && data.detalles.length > 0) {
                console.log('üìù Primer detalle:', data.detalles[0]);
            }
            
          
            showMovements(data.detalles || []);
            showTable();
            // cargar tabla de montos agregados para el rango
            cargarMontos();
            // Configuraci√≥n minimalista - sin mostrar detalles
        }

        function showReporte(data) {
            const reporteData = {
                resumen: {
                    total_movimientos: data.total_movimientos,
                    conciliados_exactos: data.estados?.CONCILIADO || 0,
                    pendientes_revision: data.estados?.PENDIENTE || 0,
                    porcentaje_automatizado: data.estados?.CONCILIADO ? 
                        ((data.estados.CONCILIADO / data.total_movimientos) * 100) : 0
                },
                detalles: data.detalles || []
            };
            
            showResults(reporteData);
            // Configuraci√≥n minimalista - sin mostrar detalles
        }

        async function cargarMontos() {
            const empresaId = document.getElementById('empresaId').value;
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const soloPue = document.getElementById('soloPue').checked;
            const url = `http://localhost:8000/api/v1/conciliacion/montos/${empresaId}?fecha_inicio=${encodeURIComponent(fechaInicio)}&fecha_fin=${encodeURIComponent(fechaFin)}&solo_pue=${soloPue}`;
            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();
                renderAmounts(data.rows || [], data);
            } catch (e) {
                console.error('No se pudo cargar montos', e);
            }
        }

        function renderAmounts(rows, meta) {
            const tbody = document.getElementById('amountsBody');
            tbody.innerHTML = '';
            rows.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>$${Number(r.monto).toFixed(2)}${r._rangos && r._rangos.length > 1 ? ` <small style="color: #666;">(${r._rangos.map(r => r.toFixed(2)).join(', ')})</small>` : ''}</td>
                    <td>${r.cfdi_count}</td>
                    <td>${r.movimientos_count}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="abrirVisita(${meta.empresa_id}, ${Number(r.monto).toFixed(2)})">Visita</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('amountsHeader').style.display = rows.length ? 'block' : 'none';
        }

        async function abrirVisita(empresaId, monto) {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const soloPue = document.getElementById('soloPue').checked;
            const url = `http://localhost:8000/api/v1/conciliacion/montos/${empresaId}/detalle?monto=${encodeURIComponent(monto)}&fecha_inicio=${encodeURIComponent(fechaInicio)}&fecha_fin=${encodeURIComponent(fechaFin)}&solo_pue=${soloPue}`;
            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();
                mostrarModalComparacion(data);
            } catch (e) {
                showError(`No se pudo cargar la visita: ${e.message}`);
            }
        }

        function mostrarModalComparacion(data) {
            // Debug: mostrar datos recibidos
            console.log('üîç Datos recibidos en modal:', data);
            console.log('üîç movimientos_abono:', data.movimientos_abono);
            console.log('üîç movimientos_cargo:', data.movimientos_cargo);
            console.log('üîç cfdis_ingreso:', data.cfdis_ingreso);
            console.log('üîç cfdis_egreso:', data.cfdis_egreso);
            
            // Verificar si hay CFDIs tipo P
            const cfdis_tipo_p_ingreso = (data.cfdis_ingreso || []).filter(c => c.tipo_comprobante === 'P');
            const cfdis_tipo_p_egreso = (data.cfdis_egreso || []).filter(c => c.tipo_comprobante === 'P');
            console.log('üîç CFDIs tipo P en ingreso:', cfdis_tipo_p_ingreso);
            console.log('üîç CFDIs tipo P en egreso:', cfdis_tipo_p_egreso);
            
            // Crear modal minimalista y organizado
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.inset = '0';
            overlay.style.background = 'rgba(0,0,0,0.6)';
            overlay.style.zIndex = '1000';

            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '50%';
            modal.style.left = '50%';
            modal.style.transform = 'translate(-50%, -50%)';
            modal.style.background = '#fafafa';
            modal.style.borderRadius = '12px';
            modal.style.width = '95%';
            modal.style.maxWidth = '1600px';
            modal.style.maxHeight = '90%';
            modal.style.overflow = 'auto';
            modal.style.padding = '24px';
            modal.style.boxShadow = '0 20px 60px rgba(0,0,0,0.3)';

            const header = document.createElement('div');
            header.style.marginBottom = '24px';
            header.style.textAlign = 'center';
            header.style.borderBottom = '2px solid #e0e0e0';
            header.style.paddingBottom = '16px';
            header.style.position = 'relative';
            
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '‚úï';
            closeBtn.style.position = 'absolute';
            closeBtn.style.right = '0';
            closeBtn.style.top = '0';
            closeBtn.style.background = 'none';
            closeBtn.style.border = 'none';
            closeBtn.style.fontSize = '24px';
            closeBtn.style.color = '#95a5a6';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.padding = '0';
            closeBtn.style.width = '32px';
            closeBtn.style.height = '32px';
            closeBtn.style.borderRadius = '50%';
            closeBtn.style.display = 'flex';
            closeBtn.style.alignItems = 'center';
            closeBtn.style.justifyContent = 'center';
            closeBtn.onmouseover = () => { closeBtn.style.background = '#ecf0f1'; closeBtn.style.color = '#e74c3c'; };
            closeBtn.onmouseout = () => { closeBtn.style.background = 'none'; closeBtn.style.color = '#95a5a6'; };
            closeBtn.onclick = () => { document.body.removeChild(overlay); };
            
            header.innerHTML = `<h2 style="margin: 0; color: #2c3e50; font-size: 1.8em;">Comparaci√≥n por monto $${Number(data.monto).toFixed(2)}</h2>`;
            header.appendChild(closeBtn);

            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = '1fr 1fr';
            grid.style.gap = '32px';

            const left = document.createElement('div');
            const right = document.createElement('div');
            
            // T√≠tulo principal para CFDIs
            left.innerHTML = `<h3 style="margin: 0 0 24px 0; color: #34495e; font-size: 1.6em; border-bottom: 2px solid #bdc3c7; padding-bottom: 8px; text-align: center;">üìÑ CFDI</h3>`;
            
            // Secci√≥n destacada para Complementos de pago (CFDI tipo P)
            const cfdisPIngreso = (data.cfdis_ingreso || []).filter(c => c.tipo_comprobante === 'P');
            const cfdisPEgreso = (data.cfdis_egreso || []).filter(c => c.tipo_comprobante === 'P');
            const totalP = (cfdisPIngreso.length + cfdisPEgreso.length);
            if (totalP > 0) {
                const cfdiPSection = document.createElement('div');
                cfdiPSection.style.marginBottom = '24px';
                cfdiPSection.innerHTML = `<h4 style="margin: 0 0 12px 0; color: #8e44ad; font-size: 1.1em; border-bottom: 1px solid #c39bd3; padding-bottom: 6px;">üîó Complementos de pago (P) - ${totalP}</h4>`;

                const cfdiPTable = document.createElement('table');
                cfdiPTable.style.width = '100%';
                cfdiPTable.style.borderCollapse = 'collapse';
                cfdiPTable.style.fontSize = '12px';
                cfdiPTable.style.marginBottom = '8px';
                const rowsP = [...cfdisPIngreso.map(c => ({...c, __rol: 'Ingreso'})), ...cfdisPEgreso.map(c => ({...c, __rol: 'Egreso'}))];
                cfdiPTable.innerHTML = `
                    <thead>
                        <tr style="background: #f3e5f5; border-bottom: 2px solid #c39bd3;">
                            <th style="padding: 8px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">UUID</th>
                            <th style="padding: 8px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">FECHA</th>
                            <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: #2c3e50; font-size: 11px;">ROL</th>
                            <th style="padding: 8px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">CONTRA PARTE</th>
                            <th style="padding: 8px 6px; text-align: right; font-weight: 600; color: #2c3e50; font-size: 11px;">MONTO PAGO</th>
                            <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: #2c3e50; font-size: 11px;">M√âTODO</th>
                            <th style="padding: 8px 6px; text-align: center; font-weight: 600; color: #2c3e50; font-size: 11px;">ESTATUS</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rowsP.map((c, index) => `
                            <tr style="border-bottom: 1px solid #ecf0f1; ${index % 2 === 0 ? 'background: #ffffff' : 'background: #faf5ff'}">
                                <td style="padding: 8px 6px; font-family: monospace; font-size: 10px; color: #7f8c8d;">${c.uuid || ''}</td>
                                <td style="padding: 8px 6px; font-weight: 500; color: #2c3e50; font-size: 11px;">${formatDateSimple(c.fecha)}</td>
                                <td style="padding: 8px 6px; text-align: center; font-weight: 700; color: ${c.__rol === 'Ingreso' ? '#27ae60' : '#e74c3c'};">${c.__rol}</td>
                                <td style="padding: 8px 6px; color: #34495e; font-size: 11px;">${c.__rol === 'Ingreso' ? (c.nombre_receptor || '') : (c.nombre_emisor || '')}</td>
                                <td style="padding: 8px 6px; text-align: right; font-weight: 700; color: #27ae60;">${c.monto_pago ? `$${Number(c.monto_pago).toFixed(2)}` : ''}</td>
                                <td style="padding: 8px 6px; text-align: center; color: #8e44ad; font-weight: 600; font-size: 11px;">${c.metodo_pago || 'PUE'}</td>
                                <td style="padding: 8px 6px; text-align: center; font-size: 11px; font-weight: 700; color: ${c.valido ? '#27ae60' : '#e74c3c'};">${c.valido ? '√öNICO' : 'REVISI√ìN'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                cfdiPSection.appendChild(cfdiPTable);
                left.appendChild(cfdiPSection);
            }

            // T√≠tulo principal para Movimientos
            right.innerHTML = `<h3 style="margin: 0 0 24px 0; color: #34495e; font-size: 1.6em; border-bottom: 2px solid #bdc3c7; padding-bottom: 8px; text-align: center;">üè¶ Movimientos</h3>`;

            // CFDI Ingreso (Empresa como Emisor)
            const cfdiIngresoSection = document.createElement('div');
            cfdiIngresoSection.style.marginBottom = '32px';
            cfdiIngresoSection.innerHTML = `<h4 style="margin: 0 0 16px 0; color: #27ae60; font-size: 1.2em; border-bottom: 1px solid #a9dfbf; padding-bottom: 8px;">üí∞ Ingreso (Empresa como Emisor) - ${data.cfdis_ingreso?.length || 0}</h4>`;
            
            const cfdiIngresoTable = document.createElement('table');
            cfdiIngresoTable.style.width = '100%';
            cfdiIngresoTable.style.borderCollapse = 'collapse';
            cfdiIngresoTable.style.fontSize = '12px';
            cfdiIngresoTable.style.marginBottom = '24px';
            cfdiIngresoTable.innerHTML = `
                <thead>
                    <tr style="background: #d5f4e6; border-bottom: 2px solid #a9dfbf;">
                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">UUID</th>
                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">FECHA</th>
                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">RECEPTOR</th>
                        <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #2c3e50; font-size: 11px;">TIPO</th>
                        <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #2c3e50; font-size: 11px;">M√âTODO</th>
                        <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #2c3e50; font-size: 11px;">ESTATUS</th>
                    </tr>
                </thead>
                <tbody>
                    ${(data.cfdis_ingreso || []).map((c, index) => {
                        // Mostrar monto de pago para tipo P, total para otros tipos
                        const montoMostrar = c.tipo_comprobante === 'P' && c.monto_pago ? 
                            `$${Number(c.monto_pago).toFixed(2)}` : 
                            (c.total ? `$${Number(c.total).toFixed(2)}` : '');
                        
                        return `
                            <tr style="border-bottom: 1px solid #ecf0f1; ${index % 2 === 0 ? 'background: #ffffff' : 'background: #f8fffe'}">
                                <td style="padding: 8px 6px; font-family: monospace; font-size: 10px; color: #7f8c8d;">${c.uuid || ''}</td>
                                <td style="padding: 8px 6px; font-weight: 500; color: #2c3e50; font-size: 11px;">${formatDateSimple(c.fecha)}</td>
                                <td style="padding: 8px 6px; color: #34495e; font-size: 11px;">${c.nombre_receptor || ''}</td>
                                <td style="padding: 8px 6px; text-align: center; color: ${c.tipo_comprobante === 'P' ? '#e67e22' : '#3498db'}; font-weight: 600; font-size: 11px;">
                                    ${c.tipo_comprobante === 'I' ? 'I PUE' : (c.tipo_comprobante === 'P' ? 'P' : c.tipo_comprobante)}
                                    ${c.tipo_comprobante === 'P' && c.monto_pago ? '<br><small style="color: #27ae60;">' + montoMostrar + '</small>' : ''}
                                </td>
                                <td style="padding: 8px 6px; text-align: center; color: #27ae60; font-weight: 600; font-size: 11px;">${c.metodo_pago || 'PUE'}</td>
                                <td style="padding: 8px 6px; text-align: center; font-size: 11px; font-weight: 700; color: ${c.valido ? '#27ae60' : '#e74c3c'};">${c.valido ? 'COINCIDENCIA' : 'REVISI√ìN'}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;

            // CFDI Egreso (Empresa como Receptor)
            const cfdiEgresoSection = document.createElement('div');
            cfdiEgresoSection.innerHTML = `<h4 style="margin: 0 0 16px 0; color: #e74c3c; font-size: 1.2em; border-bottom: 1px solid #f1948a; padding-bottom: 8px;">üí∏ Egreso (Empresa como Receptor) - ${data.cfdis_egreso?.length || 0}</h4>`;
            
            const cfdiEgresoTable = document.createElement('table');
            cfdiEgresoTable.style.width = '100%';
            cfdiEgresoTable.style.borderCollapse = 'collapse';
            cfdiEgresoTable.style.fontSize = '12px';
            cfdiEgresoTable.innerHTML = `
                <thead>
                    <tr style="background: #fadbd8; border-bottom: 2px solid #f1948a;">
                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">UUID</th>
                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">FECHA</th>
                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">EMISOR</th>
                        <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #2c3e50; font-size: 11px;">M√âTODO</th>
                        <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #2c3e50; font-size: 11px;">ESTATUS</th>
                        <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #2c3e50; font-size: 11px;">TIPO</th>
                    </tr>
                </thead>
                <tbody>
                    ${(data.cfdis_egreso || []).map((c, index) => `
                        <tr style="border-bottom: 1px solid #ecf0f1; ${index % 2 === 0 ? 'background: #ffffff' : 'background: #fffafa'}">
                            <td style="padding: 8px 6px; font-family: monospace; font-size: 10px; color: #7f8c8d;">${c.uuid || ''}</td>
                            <td style="padding: 8px 6px; font-weight: 500; color: #2c3e50; font-size: 11px;">${formatDateSimple(c.fecha)}</td>
                            <td style="padding: 8px 6px; color: #34495e; font-size: 11px;">${c.nombre_emisor || ''}</td>
                            <td style="padding: 8px 6px; text-align: center; color: #e74c3c; font-weight: 600; font-size: 11px;">${c.metodo_pago || 'PUE'}</td>
                            <td style="padding: 8px 6px; text-align: center; font-size: 11px; font-weight: 700; color: ${c.valido ? '#27ae60' : '#e74c3c'};">${c.valido ? 'COINCIDENCIA' : 'REVISI√ìN'}</td>
                            <td style="padding: 8px 6px; text-align: center; font-size: 11px; font-weight: 700; color: ${c.tipo_comprobante === 'P' ? '#e67e22' : '#3498db'};">${c.tipo_comprobante === 'I' ? 'I PUE' : (c.tipo_comprobante === 'P' ? 'P' : c.tipo_comprobante)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            // Movimientos ABONO (Entradas)
            const movAbonoSection = document.createElement('div');
            movAbonoSection.style.marginBottom = '32px';
            movAbonoSection.innerHTML = `<h4 style="margin: 0 0 16px 0; color: #27ae60; font-size: 1.2em; border-bottom: 1px solid #a9dfbf; padding-bottom: 8px;">üí∞ ABONOS (Entradas) - ${data.movimientos_abono?.length || 0}</h4>`;
            
            const movAbonoTable = document.createElement('table');
            movAbonoTable.style.width = '100%';
            movAbonoTable.style.borderCollapse = 'collapse';
            movAbonoTable.style.fontSize = '12px';
            movAbonoTable.style.marginBottom = '24px';
            movAbonoTable.innerHTML = `
                <thead>
                    <tr style="background: #d5f4e6; border-bottom: 2px solid #a9dfbf;">
                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">FECHA</th>
                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">CONCEPTO</th>
                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">REFERENCIA</th>
                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">ESTADO</th>
                        <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #2c3e50; font-size: 11px;">ESTATUS</th>
                    </tr>
                </thead>
                <tbody>
                    ${(data.movimientos_abono || []).map((m, index) => `
                        <tr style="border-bottom: 1px solid #ecf0f1; ${index % 2 === 0 ? 'background: #ffffff' : 'background: #f8fffe'}">
                            <td style="padding: 8px 6px; font-weight: 500; color: #2c3e50; font-size: 11px;">${formatDateSimple(m.fecha)}</td>
                            <td style="padding: 8px 6px; color: #34495e; font-size: 11px;">${m.concepto || ''}</td>
                            <td style="padding: 8px 6px; color: #7f8c8d; font-family: monospace; font-size: 10px;">${m.referencia || ''}</td>
                            <td style="padding: 8px 6px; text-align: left; color: #34495e; font-size: 10px; max-width: 150px; word-wrap: break-word;">${m.estado || 'Pendiente de revisi√≥n'}</td>
                            <td style="padding: 8px 6px; text-align: center; font-size: 11px; font-weight: 700; color: ${m.estado_conciliacion === 'exacta' ? '#27ae60' : '#e74c3c'};">${m.estado_conciliacion === 'exacta' ? 'COINCIDENCIA' : 'REVISI√ìN'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            // Movimientos CARGO (Salidas)
            const movCargoSection = document.createElement('div');
            movCargoSection.innerHTML = `<h4 style="margin: 0 0 16px 0; color: #e74c3c; font-size: 1.2em; border-bottom: 1px solid #f1948a; padding-bottom: 8px;">üí∏ CARGOS (Salidas) - ${data.movimientos_cargo?.length || 0}</h4>`;
            
            const movCargoTable = document.createElement('table');
            movCargoTable.style.width = '100%';
            movCargoTable.style.borderCollapse = 'collapse';
            movCargoTable.style.fontSize = '12px';
            movCargoTable.innerHTML = `
                <thead>
                    <tr style="background: #fadbd8; border-bottom: 2px solid #f1948a;">
                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">FECHA</th>
                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">CONCEPTO</th>
                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">REFERENCIA</th>
                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #2c3e50; font-size: 11px;">ESTADO</th>
                        <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #2c3e50; font-size: 11px;">ESTATUS</th>
                    </tr>
                </thead>
                <tbody>
                    ${(data.movimientos_cargo || []).map((m, index) => `
                        <tr style="border-bottom: 1px solid #ecf0f1; ${index % 2 === 0 ? 'background: #ffffff' : 'background: #fffafa'}">
                            <td style="padding: 8px 6px; font-weight: 500; color: #2c3e50; font-size: 11px;">${formatDateSimple(m.fecha)}</td>
                            <td style="padding: 8px 6px; color: #34495e; font-size: 11px;">${m.concepto || ''}</td>
                            <td style="padding: 8px 6px; color: #7f8c8d; font-family: monospace; font-size: 10px;">${m.referencia || ''}</td>
                            <td style="padding: 8px 6px; text-align: left; color: #34495e; font-size: 10px; max-width: 150px; word-wrap: break-word;">${m.estado || 'Pendiente de revisi√≥n'}</td>
                            <td style="padding: 8px 6px; text-align: center; font-size: 11px; font-weight: 700; color: ${m.estado_conciliacion === 'exacta' ? '#27ae60' : '#e74c3c'};">${m.estado_conciliacion === 'exacta' ? 'COINCIDENCIA' : 'REVISI√ìN'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            // Agregar secciones CFDI al lado izquierdo
            cfdiIngresoSection.appendChild(cfdiIngresoTable);
            left.appendChild(cfdiIngresoSection);
            
            cfdiEgresoSection.appendChild(cfdiEgresoTable);
            left.appendChild(cfdiEgresoSection);

            // Agregar secciones de Movimientos al lado derecho
            movAbonoSection.appendChild(movAbonoTable);
            right.appendChild(movAbonoSection);
            
            movCargoSection.appendChild(movCargoTable);
            right.appendChild(movCargoSection);

            grid.appendChild(left);
            grid.appendChild(right);

            modal.appendChild(header);
            modal.appendChild(grid);

            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        function coincide(baseMonto, valor, tolerancia) {
            const a = Number(baseMonto);
            const b = Number(valor);
            const tol = Number(tolerancia ?? 0.01);
            if (Number.isNaN(a) || Number.isNaN(b)) return false;
            return Math.abs(a - b) <= tol;
        }

        function formatDateSimple(dateString) {
            if (!dateString) return '';
            try {
                // Evitar desfases por zona horaria cuando viene YYYY-MM-DD
                const m = /^([0-9]{4})-([0-9]{2})-([0-9]{2})$/.exec(dateString);
                let date;
                if (m) {
                    const y = parseInt(m[1], 10);
                    const mo = parseInt(m[2], 10) - 1;
                    const d = parseInt(m[3], 10);
                    date = new Date(y, mo, d);
                } else {
                    date = new Date(dateString);
                }
                if (isNaN(date.getTime())) return dateString;
                return date.toLocaleDateString('es-MX', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }

        function getConciliacionColor(estado) {
            switch(estado) {
                case 'exacta': return '#27ae60';      // Verde
                case 'fuzzy': return '#f39c12';       // Naranja
                case 'revision_duplicados': return '#e74c3c'; // Rojo
                case 'pendiente': return '#95a5a6';   // Gris
                default: return '#34495e';            // Azul oscuro
            }
        }


        // Funci√≥n showConfigInfo eliminada - interfaz minimalista

        function showMovements(detalles) {
            console.log('üîç showMovements llamada con:', detalles);
            console.log('üìä N√∫mero de detalles:', detalles ? detalles.length : 'detalles es null/undefined');
            
            const tbody = document.getElementById('movementsBody');
            if (!tbody) {
                console.error('‚ùå No se encontr√≥ el elemento movementsBody');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (!detalles || detalles.length === 0) {
                console.log('‚ö†Ô∏è No hay detalles para mostrar');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No hay movimientos para mostrar</td></tr>';
                return;
            }
            
            console.log(`‚úÖ Procesando ${detalles.length} detalles`);
            
            try {
                detalles.forEach((detalle, index) => {
                    console.log(`üìù Procesando detalle ${index}:`, detalle);
                    
                    const row = document.createElement('tr');
                    row.className = `movement-row ${detalle.tipo || 'unknown'}`;
                    
                    // Simplificar el HTML para evitar errores
                    const montoDisplay = `$${(detalle.monto || 0).toFixed(2)}`;
                    const cfdiDisplay = detalle.cfdi_id ? `CFDI-${detalle.cfdi_id}` : 'Sin CFDI';
                    const fechaDisplay = detalle.fecha || 'N/A';
                    
                    row.innerHTML = `
                        <td>${detalle.movimiento_id || 'N/A'}</td>
                        <td>${fechaDisplay}</td>
                        <td>${(detalle.concepto || 'N/A').substring(0, 50)}...</td>
                        <td>${montoDisplay}</td>
                        <td>${detalle.cfdi_id || 'N/A'}</td>
                        <td>${detalle.tipo || 'N/A'}</td>
                        <td>${(detalle.razon || 'N/A').substring(0, 30)}...</td>
                        <td>${detalle.cfdi_receptor || 'N/A'}</td>
                    `;
                    
                    tbody.appendChild(row);
                    
                    if (index < 5) {
                        console.log(`‚úÖ Fila ${index} agregada correctamente`);
                    }
                });
                
                console.log(`‚úÖ Todas las ${detalles.length} filas procesadas`);
                
            } catch (error) {
                console.error('üí• Error procesando movimientos:', error);
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Error al procesar movimientos</td></tr>';
            }
        }

        function showTable() {
            console.log('üìã showTable() llamada');
            const table = document.getElementById('movementsTable');
            if (!table) {
                console.error('‚ùå No se encontr√≥ el elemento movementsTable');
                return;
            }
            table.style.display = 'table';
            console.log('‚úÖ Tabla mostrada');
        }

        function hideResults() {
            document.getElementById('resultsSummary').style.display = 'none';
            document.getElementById('movementsTable').style.display = 'none';
            // configInfo eliminado - interfaz minimalista
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('error').innerHTML = message;
            document.getElementById('error').style.display = 'block';
        }

        function showSuccess(message) {
            document.getElementById('success').innerHTML = message;
            document.getElementById('success').style.display = 'block';
        }

        function hideMessages() {
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
        }

        // Configurar fechas por defecto (√∫ltimo mes)
        window.onload = function() {
            // Configurar fechas para el rango donde hay datos (mayo 2025)
            const fechaInicio = new Date('2025-05-01');
            const fechaFin = new Date('2025-05-30');
            
            document.getElementById('fechaInicio').value = fechaInicio.toISOString().split('T')[0];
            document.getElementById('fechaFin').value = fechaFin.toISOString().split('T')[0];
            
            console.log('üìÖ Fechas inicializadas:', {
                inicio: fechaInicio.toISOString().split('T')[0],
                fin: fechaFin.toISOString().split('T')[0]
            });
        };
    </script>
</body>
</html> 