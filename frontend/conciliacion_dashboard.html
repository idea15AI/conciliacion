<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conciliación Bancaria</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .form-item {
            display: flex;
            flex-direction: column;
        }

        .form-item label {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .form-item input, .form-item select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .results {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .movements-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .movements-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e9ecef;
        }

        .movements-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }

        .movements-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-exact {
            background: #d5f4e6;
            color: #27ae60;
        }

        .status-fuzzy {
            background: #fef5e7;
            color: #f39c12;
        }

        .status-pending {
            background: #fadbd8;
            color: #e74c3c;
        }

        .error {
            background: #fadbd8;
            color: #c0392b;
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid #f1948a;
        }

        .success {
            background: #d5f4e6;
            color: #27ae60;
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid #a9dfbf;
        }

        .monto-comparison {
            font-family: 'Courier New', monospace;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .monto-banco {
            color: #2c3e50;
            font-weight: 600;
        }

        .monto-cfdi {
            color: #27ae60;
            font-weight: 600;
        }

        .monto-diferencia {
            color: #e74c3c;
            font-size: 0.85em;
            font-weight: 500;
        }

        .monto-label {
            font-size: 0.75em;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .monto-solo {
            color: #2c3e50;
            font-weight: 600;
        }

        .monto-info {
            font-size: 0.7em;
            color: #95a5a6;
            font-style: italic;
            margin-top: 2px;
        }

        .monto-container {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .monto-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .monto-row .monto-label {
            min-width: 60px;
        }

        @media (max-width: 768px) {
            .form-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <div class="form-group">
                <div class="form-item">
                    <label for="empresaId">Empresa ID</label>
                    <input type="number" id="empresaId" value="1" min="1">
                </div>
                <div class="form-item">
                    <label for="fechaInicio">Fecha Inicio</label>
                    <input type="date" id="fechaInicio">
                </div>
                <div class="form-item">
                    <label for="fechaFin">Fecha Fin</label>
                    <input type="date" id="fechaFin">
                </div>
                <div class="form-item">
                    <button class="btn btn-primary" onclick="ejecutarConciliacion()">Ejecutar</button>
                </div>
                <div class="form-item">
                    <button class="btn btn-secondary" onclick="obtenerReporte()">Ver Detalles</button>
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Procesando...</p>
            </div>

            <div id="error" class="error" style="display: none;"></div>
            <div id="success" class="success" style="display: none;"></div>

            <table class="movements-table" id="movementsTable">
                <thead>
                    <tr>
                        <th>Conciliación ID</th>
                        <th>Fecha</th>
                        <th>Concepto</th>
                        <th>Monto (Banco vs CFDI)</th>
                        <th>CFDI ID</th>
                        <th>Estado</th>
                        <th>Puntaje</th>
                        <th>Razón</th>
                    </tr>
                </thead>
                <tbody id="movementsBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let currentData = null;

        async function ejecutarConciliacion() {
            const empresaId = document.getElementById('empresaId').value;
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            showLoading();
            hideMessages();
            
            try {
                let url = `http://localhost:8000/api/v1/conciliacion/ejecutar/${empresaId}`;
                
                if (fechaInicio) {
                    url += `?fecha_inicio=${fechaInicio}`;
                    if (fechaFin) {
                        url += `&fecha_fin=${fechaFin}`;
                    }
                } else if (fechaFin) {
                    url += `?fecha_fin=${fechaFin}`;
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                currentData = data;
                showResults(data);
                showSuccess('Conciliación ejecutada exitosamente');
                
            } catch (error) {
                console.error('Error:', error);
                showError(`Error ejecutando conciliación: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function obtenerReporte() {
            const empresaId = document.getElementById('empresaId').value;
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            showLoading();
            hideMessages();
            
            try {
                let url = `http://localhost:8000/api/v1/conciliacion/detalles/${empresaId}`;
                
                if (fechaInicio) {
                    url += `?fecha_inicio=${fechaInicio}`;
                    if (fechaFin) {
                        url += `&fecha_fin=${fechaFin}`;
                    }
                } else if (fechaFin) {
                    url += `?fecha_fin=${fechaFin}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                showReporte(data);
                showSuccess('Detalles obtenidos exitosamente');
                
            } catch (error) {
                console.error('Error:', error);
                showError(`Error obteniendo detalles: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function showResults(data) {
            showMovements(data.detalles || []);
        }

        function showReporte(data) {
            // Crear datos de reporte en formato compatible
            const reporteData = {
                resumen: {
                    total_movimientos: data.total_movimientos,
                    conciliados_exactos: data.estados?.CONCILIADO || 0,
                    conciliados_fuzzy: 0,
                    pendientes_revision: data.estados?.PENDIENTE || 0,
                    porcentaje_automatizado: data.estados?.CONCILIADO ? 
                        ((data.estados.CONCILIADO / data.total_movimientos) * 100) : 0
                },
                detalles: []
            };
            
            showResults(reporteData);
        }

        function showMovements(detalles) {
            const tbody = document.getElementById('movementsBody');
            tbody.innerHTML = '';
            
            detalles.forEach(detalle => {
                const row = document.createElement('tr');
                row.className = `movement-row ${detalle.tipo}`;
                
                const statusClass = detalle.tipo === 'exacta' ? 'status-exact' : 
                                  detalle.tipo === 'fuzzy' ? 'status-fuzzy' : 'status-pending';

                const movMonto = typeof detalle.monto === 'number' ? detalle.monto : (parseFloat(detalle.monto) || 0);
                const cfdiMontoRaw = detalle.cfdi_monto ?? detalle.cfdi_total ?? null;
                const cfdiMonto = cfdiMontoRaw != null ? (typeof cfdiMontoRaw === 'number' ? cfdiMontoRaw : (parseFloat(cfdiMontoRaw) || null)) : null;
                const delta = (cfdiMonto != null) ? (movMonto - cfdiMonto) : null;
                
                // Formatear la comparación de montos
                let montoDisplay = '';
                if (cfdiMonto != null) {
                    const diferencia = Math.abs(delta);
                    const signoDiferencia = delta > 0 ? '+' : '-';
                    const textoDiferencia = delta !== 0 ? `${signoDiferencia}$${diferencia.toFixed(2)}` : 'Sin diferencia';
                    const infoDiferencia = delta > 0 ? '(Banco > CFDI)' : delta < 0 ? '(Banco < CFDI)' : '(Coinciden)';
                    
                    montoDisplay = `<div class="monto-container">
                        <div class="monto-row">
                            <span class="monto-label">Banco:</span>
                            <span class="monto-banco">$${movMonto.toFixed(2)}</span>
                        </div>
                        <div class="monto-row">
                            <span class="monto-label">CFDI:</span>
                            <span class="monto-cfdi">$${cfdiMonto.toFixed(2)}</span>
                        </div>
                        <div class="monto-row">
                            <span class="monto-label">Diferencia:</span>
                            <span class="monto-diferencia">${textoDiferencia}</span>
                        </div>
                        <div class="monto-info">${infoDiferencia}</div>
                    </div>`;
                } else {
                    montoDisplay = `<div class="monto-container">
                        <div class="monto-row">
                            <span class="monto-label">Banco:</span>
                            <span class="monto-solo">$${movMonto.toFixed(2)}</span>
                        </div>
                        <div class="monto-info">Sin CFDI para comparar</div>
                    </div>`;
                }

                row.innerHTML = `
                    <td>${detalle.movimiento_id ?? 'N/A'}</td>
                    <td>${formatDate(detalle.fecha)}</td>
                    <td>${detalle.concepto || 'N/A'}</td>
                    <td>${montoDisplay}</td>
                    <td>${detalle.cfdi_id || 'N/A'}</td>
                    <td><span class="status-badge ${statusClass}">${detalle.tipo}</span></td>
                    <td>${detalle.puntaje_fuzzy ? `${detalle.puntaje_fuzzy}%` : 'N/A'}</td>
                    <td>${detalle.razon || 'N/A'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES');
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
        }

        function showSuccess(message) {
            document.getElementById('success').textContent = message;
            document.getElementById('success').style.display = 'block';
        }

        function hideMessages() {
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
        }

        // Configurar fechas por defecto (último mes)
        window.onload = function() {
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            
            document.getElementById('fechaInicio').value = lastMonth.toISOString().split('T')[0];
            document.getElementById('fechaFin').value = today.toISOString().split('T')[0];
        };
    </script>
</body>
</html> 