<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conciliaci√≥n Bancaria - Dashboard Mejorado</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .controls h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.3em;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }

        .form-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            align-items: end;
            margin-bottom: 20px;
        }

        .form-group-advanced {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .form-item {
            display: flex;
            flex-direction: column;
        }

        .form-item label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-item input, .form-item select {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-item input:focus, .form-item select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3498db;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f8b);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #229954, #1e8449);
            transform: translateY(-2px);
        }

        .results {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .results-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .summary-card.warning {
            border-left: 4px solid #ff9800;
            background: linear-gradient(135deg, #fff3e0 0%, #ffffff 100%);
        }

        .summary-number {
            font-size: 2em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .summary-label {
            color: #7f8c8d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .movements-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .movements-table th {
            background: #2c3e50;
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .movements-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }

        .movements-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .status-exact {
            background: #d5f4e6;
            color: #27ae60;
            border: 1px solid #a9dfbf;
        }

        .status-fuzzy {
            background: #fef5e7;
            color: #f39c12;
            border: 1px solid #fad7a0;
        }

        .status-pending {
            background: #fadbd8;
            color: #e74c3c;
            border: 1px solid #f1948a;
        }
        
        .status-duplicados {
            background: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }

        .error {
            background: #fadbd8;
            color: #c0392b;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #f1948a;
            border-left: 4px solid #e74c3c;
        }

        .success {
            background: #d5f4e6;
            color: #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #a9dfbf;
            border-left: 4px solid #27ae60;
        }

        .monto-comparison {
            font-family: 'Courier New', monospace;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .monto-banco {
            color: #2c3e50;
            font-weight: 600;
        }

        .monto-cfdi {
            color: #27ae60;
            font-weight: 600;
        }

        .monto-diferencia {
            color: #e74c3c;
            font-size: 0.85em;
            font-weight: 500;
        }

        .monto-label {
            font-size: 0.75em;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 70px;
            display: inline-block;
        }

        .monto-solo {
            color: #2c3e50;
            font-weight: 600;
        }

        .monto-info {
            font-size: 0.7em;
            color: #95a5a6;
            font-style: italic;
            margin-top: 3px;
        }

        .monto-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .monto-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .receptor-info {
            background: #e8f5e8;
            color: #27ae60;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-top: 5px;
            border: 1px solid #a9dfbf;
        }

        .config-info {
            background: #e3f2fd;
            color: #1976d2;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .config-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-value {
            font-weight: 600;
            color: #1565c0;
        }

        @media (max-width: 768px) {
            .form-group, .form-group-advanced {
                grid-template-columns: 1fr;
            }
            
            .results-summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ Conciliaci√≥n Bancaria</h1>
            <p>Sistema inteligente de conciliaci√≥n con prioridad PUE, monto y fecha</p>
        </div>

        <div class="controls">
            <h3>‚öôÔ∏è Configuraci√≥n de Conciliaci√≥n</h3>
            
            <div class="form-group">
                <div class="form-item">
                    <label for="empresaId">Empresa ID</label>
                    <input type="number" id="empresaId" value="1" min="1">
                </div>
                <div class="form-item">
                    <label for="fechaInicio">Fecha Inicio</label>
                    <input type="date" id="fechaInicio">
                </div>
                <div class="form-item">
                    <label for="fechaFin">Fecha Fin</label>
                    <input type="date" id="fechaFin">
                </div>
                
            </div>

            <div class="form-group-advanced">
                <div class="form-item">
                    <div class="checkbox-group">
                        <input type="checkbox" id="soloPue" checked>
                        <label for="soloPue">Solo PUE (Pago en Una Exhibici√≥n)</label>
                    </div>
                </div>
                <div class="form-item">
                    <div class="checkbox-group">
                        <input type="checkbox" id="incluirPpd">
                        <label for="incluirPpd">Incluir PPD (Complementos de Pago)</label>
                    </div>
                </div>
                <div class="form-item">
                    <button class="btn btn-primary" onclick="ejecutarConciliacion()">üöÄ Ejecutar Conciliaci√≥n</button>
                </div>
                <div class="form-item">
                    <button class="btn btn-secondary" onclick="obtenerReporte()">üìä Ver Detalles</button>
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Procesando conciliaci√≥n...</p>
            </div>

            <div id="error" class="error" style="display: none;"></div>
            <div id="success" class="success" style="display: none;"></div>

            <div id="configInfo" class="config-info" style="display: none;">
                <strong>üîß Configuraci√≥n Aplicada:</strong>
                <div class="config-grid" id="configGrid"></div>
            </div>

            <div id="resultsSummary" class="results-header" style="display: none;">
                <div class="results-summary" id="summaryGrid"></div>
            </div>

            <div class="results-header" id="amountsHeader" style="display:none;">
                <h3>Resumen por montos</h3>
                <table class="movements-table" id="amountsTable">
                    <thead>
                        <tr>
                            <th>Monto</th>
                            <th>CFDI</th>
                            <th>Movimientos</th>
                            <th>Visita</th>
                        </tr>
                    </thead>
                    <tbody id="amountsBody"></tbody>
                </table>
            </div>

            <table class="movements-table" id="movementsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID Movimiento</th>
                        <th>Fecha</th>
                        <th>Concepto</th>
                        <th>Monto (Banco vs CFDI)</th>
                        <th>CFDI ID</th>
                        <th>Estado</th>
                        <th>Puntaje</th>
                        <th>Raz√≥n</th>
                        <th>Receptor</th>
                    </tr>
                </thead>
                <tbody id="movementsBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let currentData = null;

        async function ejecutarConciliacion() {
            const empresaId = document.getElementById('empresaId').value;
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const soloPue = document.getElementById('soloPue').checked;
            const incluirPpd = document.getElementById('incluirPpd').checked;
            const umbralFuzzy = 0; // Fuzzy desactivado
            
            showLoading();
            hideMessages();
            hideResults();
            
            try {
                let url = `http://localhost:8000/api/v1/conciliacion/ejecutar/${empresaId}`;
                const params = new URLSearchParams();
                
                if (fechaInicio) params.append('fecha_inicio', fechaInicio);
                if (fechaFin) params.append('fecha_fin', fechaFin);
                params.append('solo_pue', soloPue);
                params.append('incluir_ppd', incluirPpd);
                // Fuzzy desactivado
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                currentData = data;
                showResults(data);
                showConfigInfo(soloPue, incluirPpd, umbralFuzzy);
                showSuccess('‚úÖ Conciliaci√≥n ejecutada exitosamente');
                
            } catch (error) {
                console.error('Error:', error);
                showError(`‚ùå Error ejecutando conciliaci√≥n: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function obtenerReporte() {
            const empresaId = document.getElementById('empresaId').value;
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            showLoading();
            hideMessages();
            hideResults();
            
            try {
                let url = `http://localhost:8000/api/v1/conciliacion/detalles/${empresaId}`;
                const params = new URLSearchParams();
                
                if (fechaInicio) params.append('fecha_inicio', fechaInicio);
                if (fechaFin) params.append('fecha_fin', fechaFin);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                showReporte(data);
                showSuccess('üìä Detalles obtenidos exitosamente');
                
            } catch (error) {
                console.error('Error:', error);
                showError(`‚ùå Error obteniendo detalles: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function showResults(data) {
            showSummary(data.resumen || {});
            showMovements(data.detalles || []);
            showTable();
            // cargar tabla de montos agregados para el rango
            cargarMontos();
        }

        function showReporte(data) {
            const reporteData = {
                resumen: {
                    total_movimientos: data.total_movimientos,
                    conciliados_exactos: data.estados?.CONCILIADO || 0,
                    conciliados_fuzzy: 0,
                    pendientes_revision: data.estados?.PENDIENTE || 0,
                    porcentaje_automatizado: data.estados?.CONCILIADO ? 
                        ((data.estados.CONCILIADO / data.total_movimientos) * 100) : 0
                },
                detalles: data.detalles || []
            };
            
            showResults(reporteData);
        }

        async function cargarMontos() {
            const empresaId = document.getElementById('empresaId').value;
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const soloPue = document.getElementById('soloPue').checked;
            const url = `http://localhost:8000/api/v1/conciliacion/montos/${empresaId}?fecha_inicio=${encodeURIComponent(fechaInicio)}&fecha_fin=${encodeURIComponent(fechaFin)}&solo_pue=${soloPue}`;
            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();
                renderAmounts(data.rows || [], data);
            } catch (e) {
                console.error('No se pudo cargar montos', e);
            }
        }

        function renderAmounts(rows, meta) {
            const tbody = document.getElementById('amountsBody');
            tbody.innerHTML = '';
            rows.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>$${Number(r.monto).toFixed(2)}${r._rangos && r._rangos.length > 1 ? ` <small style="color: #666;">(${r._rangos.map(r => r.toFixed(2)).join(', ')})</small>` : ''}</td>
                    <td>${r.cfdi_count}</td>
                    <td>${r.movimientos_count}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="abrirVisita(${meta.empresa_id}, ${Number(r.monto).toFixed(2)})">Visita</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('amountsHeader').style.display = rows.length ? 'block' : 'none';
        }

        async function abrirVisita(empresaId, monto) {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const soloPue = document.getElementById('soloPue').checked;
            const url = `http://localhost:8000/api/v1/conciliacion/montos/${empresaId}/detalle?monto=${encodeURIComponent(monto)}&fecha_inicio=${encodeURIComponent(fechaInicio)}&fecha_fin=${encodeURIComponent(fechaFin)}&solo_pue=${soloPue}`;
            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();
                mostrarModalComparacion(data);
            } catch (e) {
                showError(`No se pudo cargar la visita: ${e.message}`);
            }
        }

        function mostrarModalComparacion(data) {
            // Crear modal minimalista y organizado
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.inset = '0';
            overlay.style.background = 'rgba(0,0,0,0.6)';
            overlay.style.zIndex = '1000';

            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '50%';
            modal.style.left = '50%';
            modal.style.transform = 'translate(-50%, -50%)';
            modal.style.background = '#fafafa';
            modal.style.borderRadius = '12px';
            modal.style.width = '95%';
            modal.style.maxWidth = '1600px';
            modal.style.maxHeight = '90%';
            modal.style.overflow = 'auto';
            modal.style.padding = '24px';
            modal.style.boxShadow = '0 20px 60px rgba(0,0,0,0.3)';

            const header = document.createElement('div');
            header.style.marginBottom = '24px';
            header.style.textAlign = 'center';
            header.style.borderBottom = '2px solid #e0e0e0';
            header.style.paddingBottom = '16px';
            header.style.position = 'relative';
            
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '‚úï';
            closeBtn.style.position = 'absolute';
            closeBtn.style.right = '0';
            closeBtn.style.top = '0';
            closeBtn.style.background = 'none';
            closeBtn.style.border = 'none';
            closeBtn.style.fontSize = '24px';
            closeBtn.style.color = '#95a5a6';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.padding = '0';
            closeBtn.style.width = '32px';
            closeBtn.style.height = '32px';
            closeBtn.style.borderRadius = '50%';
            closeBtn.style.display = 'flex';
            closeBtn.style.alignItems = 'center';
            closeBtn.style.justifyContent = 'center';
            closeBtn.onmouseover = () => { closeBtn.style.background = '#ecf0f1'; closeBtn.style.color = '#e74c3c'; };
            closeBtn.onmouseout = () => { closeBtn.style.background = 'none'; closeBtn.style.color = '#95a5a6'; };
            closeBtn.onclick = () => { document.body.removeChild(overlay); };
            
            header.innerHTML = `<h2 style="margin: 0; color: #2c3e50; font-size: 1.8em;">Comparaci√≥n por monto $${Number(data.monto).toFixed(2)}</h2>`;
            header.appendChild(closeBtn);

            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = '1fr 1fr';
            grid.style.gap = '32px';

            const left = document.createElement('div');
            left.innerHTML = `<h3 style="margin: 0 0 16px 0; color: #34495e; font-size: 1.4em; border-bottom: 1px solid #bdc3c7; padding-bottom: 8px;">üìÑ CFDI (${data.cfdis.length})</h3>`;
            const right = document.createElement('div');
            right.innerHTML = `<h3 style="margin: 0 0 16px 0; color: #34495e; font-size: 1.4em; border-bottom: 1px solid #bdc3c7; padding-bottom: 8px;">üè¶ Movimientos (${data.movimientos.length})</h3>`;

            const cfdiTable = document.createElement('table');
            cfdiTable.style.width = '100%';
            cfdiTable.style.borderCollapse = 'collapse';
            cfdiTable.style.fontSize = '13px';
            cfdiTable.innerHTML = `
                <thead>
                    <tr style="background: #ecf0f1; border-bottom: 2px solid #bdc3c7;">
                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #2c3e50;">UUID</th>
                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #2c3e50;">FECHA</th>
                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #2c3e50;">RECEPTOR</th>
                        <th style="padding: 12px 8px; text-align: center; font-weight: 600; color: #2c3e50;">M√âTODO</th>
                        <th style="padding: 12px 8px; text-align: center; font-weight: 600; color: #2c3e50;">ESTATUS</th>
                       
                    </tr>
                </thead>
                <tbody>
                    ${data.cfdis.map((c, index) => `
                        <tr style="border-bottom: 1px solid #ecf0f1; ${index % 2 === 0 ? 'background: #ffffff' : 'background: #f8f9fa'}">
                            <td style="padding: 10px 8px; font-family: monospace; font-size: 11px; color: #7f8c8d;">${c.uuid || ''}</td>
                            <td style="padding: 10px 8px; font-weight: 500; color: #2c3e50;">${formatDateSimple(c.fecha)}</td>
                            <td style="padding: 10px 8px; color: #34495e;">${c.nombre_receptor || ''}</td>
                            <td style="padding: 10px 8px; text-align: center; color: #27ae60; font-weight: 600;">${c.metodo_pago || ''}</td>
                            <td style="padding: 10px 8px; text-align: center; font-size: 12px; font-weight: 700; color: ${c.valido ? '#27ae60' : '#e74c3c'};">${c.valido ? 'UNICO' : 'REVISI√ìN'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            const movTable = document.createElement('table');
            movTable.style.width = '100%';
            movTable.style.borderCollapse = 'collapse';
            movTable.style.fontSize = '13px';
            movTable.innerHTML = `
                <thead>
                    <tr style="background: #ecf0f1; border-bottom: 2px solid #bdc3c7;">
                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #2c3e50;">FECHA</th>
                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #2c3e50;">CONCEPTO</th>
                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #2c3e50;">REFERENCIA</th>
                        <th style="padding: 12px 8px; text-align: center; font-weight: 600; color: #2c3e50;">CARGO/ABONO</th>
                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #2c3e50;">ESTADO</th>
                        <th style="padding: 12px 8px; text-align: center; font-weight: 600; color: #2c3e50;">ESTATUS</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.movimientos.map((m, index) => `
                        <tr style="border-bottom: 1px solid #ecf0f1; ${index % 2 === 0 ? 'background: #ffffff' : 'background: #f8f9fa'}">
                            <td style="padding: 10px 8px; font-weight: 500; color: #2c3e50;">${formatDateSimple(m.fecha)}</td>
                            <td style="padding: 10px 8px; color: #34495e;">${m.concepto || ''}</td>
                            <td style="padding: 10px 8px; color: #7f8c8d; font-family: monospace; font-size: 11px;">${m.referencia || ''}</td>
                            <td style="padding: 10px 8px; text-align: center; color: ${m.cargo_abono === 'CARGO' ? '#e74c3c' : '#27ae60'}; font-weight: 600; font-size: 12px;">${m.cargo_abono || 'ABONO'}</td>
                            <td style="padding: 10px 8px; text-align: left; color: #34495e; font-size: 11px; max-width: 200px; word-wrap: break-word;">${m.estado || 'Pendiente de revisi√≥n'}</td>
                            <td style="padding: 10px 8px; text-align: center; font-size: 12px; font-weight: 700; color: ${m.estado_conciliacion === 'exacta' ? '#27ae60' : '#e74c3c'};">${m.estado_conciliacion === 'exacta' ? 'CONCILIADO' : 'REVISI√ìN'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            left.appendChild(cfdiTable);
            right.appendChild(movTable);
            grid.appendChild(left);
            grid.appendChild(right);

            modal.appendChild(header);
            modal.appendChild(grid);

            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        function coincide(baseMonto, valor, tolerancia) {
            const a = Number(baseMonto);
            const b = Number(valor);
            const tol = Number(tolerancia ?? 0.01);
            if (Number.isNaN(a) || Number.isNaN(b)) return false;
            return Math.abs(a - b) <= tol;
        }

        function formatDateSimple(dateString) {
            if (!dateString) return '';
            try {
                // Evitar desfases por zona horaria cuando viene YYYY-MM-DD
                const m = /^([0-9]{4})-([0-9]{2})-([0-9]{2})$/.exec(dateString);
                let date;
                if (m) {
                    const y = parseInt(m[1], 10);
                    const mo = parseInt(m[2], 10) - 1;
                    const d = parseInt(m[3], 10);
                    date = new Date(y, mo, d);
                } else {
                    date = new Date(dateString);
                }
                if (isNaN(date.getTime())) return dateString;
                return date.toLocaleDateString('es-MX', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }

        function getConciliacionColor(estado) {
            switch(estado) {
                case 'exacta': return '#27ae60';      // Verde
                case 'fuzzy': return '#f39c12';       // Naranja
                case 'revision_duplicados': return '#e74c3c'; // Rojo
                case 'pendiente': return '#95a5a6';   // Gris
                default: return '#34495e';            // Azul oscuro
            }
        }

        function showSummary(resumen) {
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = `
                <div class="summary-card">
                    <div class="summary-number">${resumen.total_movimientos || 0}</div>
                    <div class="summary-label">Total Movimientos</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${resumen.conciliados_exactos || 0}</div>
                    <div class="summary-label">Conciliados Exactos</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${resumen.conciliados_fuzzy || 0}</div>
                    <div class="summary-label">Conciliados Fuzzy</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${resumen.pendientes_revision || 0}</div>
                    <div class="summary-label">Pendientes Revisi√≥n</div>
                </div>
                <div class="summary-card warning">
                    <div class="summary-number">${resumen.duplicados_revision || 0}</div>
                    <div class="summary-label">Duplicados (Revisi√≥n)</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${(resumen.porcentaje_automatizado || 0).toFixed(1)}%</div>
                    <div class="summary-label">Automatizado</div>
                </div>
            `;
            document.getElementById('resultsSummary').style.display = 'block';
        }

        function showConfigInfo(soloPue, incluirPpd, umbralFuzzy) {
            const configGrid = document.getElementById('configGrid');
            configGrid.innerHTML = `
                <div class="config-item">
                    <span>PUE:</span>
                    <span class="config-value">${soloPue ? '‚úÖ Solo PUE' : '‚ùå Incluye otros'}</span>
                </div>
                <div class="config-item">
                    <span>PPD:</span>
                    <span class="config-value">${incluirPpd ? '‚úÖ Incluido' : '‚ùå Excluido'}</span>
                </div>
                <div class="config-item">
                    <span>Umbral Fuzzy:</span>
                    <span class="config-value">${umbralFuzzy}%</span>
                </div>
            `;
            document.getElementById('configInfo').style.display = 'block';
        }

        function showMovements(detalles) {
            const tbody = document.getElementById('movementsBody');
            tbody.innerHTML = '';
            
            detalles.forEach(detalle => {
                const row = document.createElement('tr');
                row.className = `movement-row ${detalle.tipo}`;
                
                const statusClass = detalle.tipo === 'exacta' ? 'status-exact' : 
                                  detalle.tipo === 'fuzzy' ? 'status-fuzzy' : 
                                  detalle.tipo === 'revision_duplicados' ? 'status-duplicados' : 'status-pending';

                const movMonto = typeof detalle.monto === 'number' ? detalle.monto : (parseFloat(detalle.monto) || 0);
                const cfdiMontoRaw = detalle.cfdi_monto ?? detalle.cfdi_total ?? null;
                const cfdiMonto = cfdiMontoRaw != null ? (typeof cfdiMontoRaw === 'number' ? cfdiMontoRaw : (parseFloat(cfdiMontoRaw) || null)) : null;
                const delta = (cfdiMonto != null) ? (movMonto - cfdiMonto) : null;
                
                // Formatear la comparaci√≥n de montos
                let montoDisplay = '';
                if (cfdiMonto != null) {
                    const diferencia = Math.abs(delta);
                    const signoDiferencia = delta > 0 ? '+' : '-';
                    const textoDiferencia = delta !== 0 ? `${signoDiferencia}$${diferencia.toFixed(2)}` : 'Sin diferencia';
                    const infoDiferencia = delta > 0 ? '(Banco > CFDI)' : delta < 0 ? '(Banco < CFDI)' : '(Coinciden)';
                    
                    montoDisplay = `<div class="monto-container">
                        <div class="monto-row">
                            <span class="monto-label">Banco:</span>
                            <span class="monto-banco">$${movMonto.toFixed(2)}</span>
                        </div>
                        <div class="monto-row">
                            <span class="monto-label">CFDI:</span>
                            <span class="monto-cfdi">$${cfdiMonto.toFixed(2)}</span>
                        </div>
                        <div class="monto-row">
                            <span class="monto-label">Diferencia:</span>
                            <span class="monto-diferencia">${textoDiferencia}</span>
                        </div>
                        <div class="monto-info">${infoDiferencia}</div>
                    </div>`;
                } else {
                    montoDisplay = `<div class="monto-container">
                        <div class="monto-row">
                            <span class="monto-label">Banco:</span>
                            <span class="monto-solo">$${movMonto.toFixed(2)}</span>
                        </div>
                        <div class="monto-info">Sin CFDI para comparar</div>
                    </div>`;
                }

                // Mostrar receptor si existe
                const receptorDisplay = detalle.cfdi_receptor ? 
                    `<div class="receptor-info">üë§ ${detalle.cfdi_receptor}</div>` : 'N/A';

                row.innerHTML = `
                    <td>${detalle.movimiento_id ?? 'N/A'}</td>
                    <td>${formatDate(detalle.fecha)}</td>
                    <td>${detalle.concepto || 'N/A'}</td>
                    <td>${montoDisplay}</td>
                    <td>${detalle.cfdi_id || 'N/A'}</td>
                    <td><span class="status-badge ${statusClass}">${detalle.tipo}</span></td>
                    <td>${detalle.puntaje_fuzzy ? `${detalle.puntaje_fuzzy}%` : 'N/A'}</td>
                    <td>${detalle.razon || 'N/A'}</td>
                    <td>${receptorDisplay}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function showTable() {
            document.getElementById('movementsTable').style.display = 'table';
        }

        function hideResults() {
            document.getElementById('resultsSummary').style.display = 'none';
            document.getElementById('movementsTable').style.display = 'none';
            document.getElementById('configInfo').style.display = 'none';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('error').innerHTML = message;
            document.getElementById('error').style.display = 'block';
        }

        function showSuccess(message) {
            document.getElementById('success').innerHTML = message;
            document.getElementById('success').style.display = 'block';
        }

        function hideMessages() {
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
        }

        // Configurar fechas por defecto (√∫ltimo mes)
        window.onload = function() {
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            
            document.getElementById('fechaInicio').value = lastMonth.toISOString().split('T')[0];
            document.getElementById('fechaFin').value = today.toISOString().split('T')[0];
        };
    </script>
</body>
</html> 